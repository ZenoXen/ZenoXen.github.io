<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.2">

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="SuTVn6gv8weF_knNFdEx4AKRDjWs3RjZB-9bXgcb_WU">
  <meta name="baidu-site-verification" content="code-BQ7MD7iclp">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.zenoxen.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="spring web flow是一个web框架，用于构建基于流程的web应用，它可以用于将程序的流程和实现分隔开。">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringWebFlow入门及案例">
<meta property="og:url" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/index.html">
<meta property="og:site_name" content="ZenoX博客">
<meta property="og:description" content="spring web flow是一个web框架，用于构建基于流程的web应用，它可以用于将程序的流程和实现分隔开。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/1.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/1.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/2.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/3.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/4.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/5.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/6.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/7.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/8.png">
<meta property="og:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/9.png">
<meta property="article:published_time" content="2021-03-01T12:29:59.000Z">
<meta property="article:modified_time" content="2022-06-23T03:49:53.127Z">
<meta property="article:author" content="ZenoX">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="SpringWebFlow">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/1.png">


<link rel="canonical" href="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/","path":"2021/03/01/SpringWebFlow入门及案例/","title":"SpringWebFlow入门及案例"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SpringWebFlow入门及案例 | ZenoX博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ZenoX博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">个人笔记本</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">流程基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8A%B6%E6%80%81"><span class="nav-number">2.1.</span> <span class="nav-text">状态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E7%8A%B6%E6%80%81"><span class="nav-number">2.1.1.</span> <span class="nav-text">视图状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%8C%E4%B8%BA%E7%8A%B6%E6%80%81"><span class="nav-number">2.1.2.</span> <span class="nav-text">行为状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%B3%E7%AD%96%E7%8A%B6%E6%80%81"><span class="nav-number">2.1.3.</span> <span class="nav-text">决策状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%90%E6%B5%81%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="nav-number">2.1.4.</span> <span class="nav-text">子流程状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9D%9F%E7%8A%B6%E6%80%81"><span class="nav-number">2.1.5.</span> <span class="nav-text">结束状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AC%E7%A7%BB"><span class="nav-number">2.2.</span> <span class="nav-text">转移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E8%BD%AC%E7%A7%BB"><span class="nav-number">2.2.1.</span> <span class="nav-text">全局转移</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E6%95%B0%E6%8D%AE"><span class="nav-number">2.3.</span> <span class="nav-text">流程数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">2.3.1.</span> <span class="nav-text">数据作用域</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%8A%AB%E8%90%A8%E8%AE%A2%E8%B4%AD"><span class="nav-number">3.</span> <span class="nav-text">完整案例：披萨订购</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Maven%E4%BE%9D%E8%B5%96"><span class="nav-number">3.1.</span> <span class="nav-text">Maven依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#web-xml"><span class="nav-number">3.2.1.</span> <span class="nav-text">web.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringMVC%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.2.</span> <span class="nav-text">SpringMVC配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringWebFlow%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.3.</span> <span class="nav-text">SpringWebFlow配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.4.</span> <span class="nav-text">Spring主配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.3.</span> <span class="nav-text">流程实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spizza-flow%E4%B8%BB%E6%B5%81%E7%A8%8B"><span class="nav-number">3.3.1.</span> <span class="nav-text">spizza-flow主流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#identifyCustomer%E5%AD%90%E6%B5%81%E7%A8%8B"><span class="nav-number">3.3.2.</span> <span class="nav-text">identifyCustomer子流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#buildOrder%E5%AD%90%E6%B5%81%E7%A8%8B"><span class="nav-number">3.3.3.</span> <span class="nav-text">buildOrder子流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#takePayment%E5%AD%90%E6%B5%81%E7%A8%8B"><span class="nav-number">3.3.4.</span> <span class="nav-text">takePayment子流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C"><span class="nav-number">3.4.</span> <span class="nav-text">运行效果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">4.</span> <span class="nav-text">完整代码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-number">5.</span> <span class="nav-text">参考文章</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZenoX"
      src="/uploads/avatar.png">
  <p class="site-author-name" itemprop="name">ZenoX</p>
  <div class="site-description" itemprop="description">百无聊赖的生活</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zenoxen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zenoxen" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zenox2105@gmail.com" title="E-Mail → mailto:zenox2105@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.zenoxen.cn/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="ZenoX">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZenoX博客">
      <meta itemprop="description" content="百无聊赖的生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SpringWebFlow入门及案例 | ZenoX博客">
      <meta itemprop="description" content="spring web flow是一个web框架，用于构建基于流程的web应用，它可以用于将程序的流程和实现分隔开。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringWebFlow入门及案例
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-01 20:29:59" itemprop="dateCreated datePublished" datetime="2021-03-01T20:29:59+08:00">2021-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-23 11:49:53" itemprop="dateModified" datetime="2022-06-23T11:49:53+08:00">2022-06-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/SpringWebFlow/" itemprop="url" rel="index"><span itemprop="name">SpringWebFlow</span></a>
        </span>
    </span>

  
    <span id="/2021/03/01/SpringWebFlow%E5%85%A5%E9%97%A8%E5%8F%8A%E6%A1%88%E4%BE%8B/" class="post-meta-item leancloud_visitors" data-flag-title="SpringWebFlow入门及案例" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

            <div class="post-description">spring web flow是一个web框架，用于构建基于流程的web应用，它可以用于将程序的流程和实现分隔开。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一般我们在构建基于模板的Web应用时，会使用SpringMVC，模板技术可能会选择jsp、thymeleaf、freemarker等，如果Model、View、Controller各层次之间的交互和跳转比较简单的话，自然是再好不过的了，但如果比较复杂的话，那么一般的MVC模式就显得吃力不讨好了。</p>
<p>SpringWebFlow是一种基于SpringMVC的web流程框架，我们可以用它来管理Model和View的交互，是的，你没看错，甚至连一个Controller也不需要写，就可以完成一整个Web应用。</p>
<p>我们的Web应用一般都是以一个个<strong>流程</strong>组成的，比如现在有这样一个需求，披萨店需要一个Web应用来让客户订购披萨，将整个应用转换为流程，如下图所示。</p>
<p><img src="1.png" alt="1"></p>
<p>整个流程无非就是识别用户-&gt;创建订单-&gt;支付订单-&gt;保存订单，使用SpringWebFlow可以很直观的将它实现，而不需要写Controller层。</p>
<h1 id="流程基本概念"><a href="#流程基本概念" class="headerlink" title="流程基本概念"></a>流程基本概念</h1><p>在Spring Web Flow中，有三个主要的组成部分，即状态(state)、转移(transition)、流程数据。</p>
<p>假设一个完整流程是这样的。</p>
<p>A-&gt;B-&gt;C</p>
<p>那么A、B、C三个节点就是状态，而转移是三个节点之间的横线，它关注的是如何从一个状态转到另一个状态，在几个节点之间传递的就是流程数据。</p>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><p>状态有5种类型。</p>
<table>
<thead>
<tr>
<th>状态类型</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>行为（Action）</td>
<td>简单地执行逻辑</td>
</tr>
<tr>
<td>决策（Decision）</td>
<td>即分支节点，根据运行结果决定走向哪个状态</td>
</tr>
<tr>
<td>结束（End）</td>
<td>执行结束状态后，整个流程宣告结束</td>
</tr>
<tr>
<td>子流程（Subflow）</td>
<td>在当前状态的上下文中启动一个全新的流程，子流程走完以后继续原流程的执行，也就是说一个节点代表一个流程</td>
</tr>
<tr>
<td>视图（View）</td>
<td>将视图返回给用户，用户使用完视图后，才继续执行原流程</td>
</tr>
</tbody></table>
<h3 id="视图状态"><a href="#视图状态" class="headerlink" title="视图状态"></a>视图状态</h3><p>一般来说，如果没有视图状态，则整个流程是根据用户最开始的输入自动执行的。</p>
<p>而如果在流程中中定义了一个视图状态（View State），则会向用户展示一个视图，用户通过视图进行输入，从而影响到流程后续走向。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">&quot;welcome&quot;</span> <span class="attr">view</span>=<span class="string">&quot;greeting&quot;</span> <span class="attr">model</span>=<span class="string">&quot;flowScope.paymentDetails&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>用view-state标签来表示视图状态，如果只提供一个id，比如id=”welcome”，则代表该状态的id为welcome，其对应的视图名也为welcome；提供view属性可以指定该state对应的view名；提供model属性可以指定该view绑定一个model对象，比如上面的例子，从flow作用域中取出paymentDetails对象，并交给greeting视图使用。</p>
<h3 id="行为状态"><a href="#行为状态" class="headerlink" title="行为状态"></a>行为状态</h3><p>简单执行一些逻辑，并转移到另一个状态。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">&quot;saveOrder&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;pizzaFlowActions.saveOrder(order)&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">&quot;thankYou&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>evaluate子标签可以填一个表达式（可以是SpEL、OGNL、Unified EL），比如上面的例子中，代表要执行pizzaFlowActions这个bean里的saveOrder方法。</p>
<p>transition子标签指明下一个状态走哪个，上面的例子中，下一个状态是thankYou。</p>
<h3 id="决策状态"><a href="#决策状态" class="headerlink" title="决策状态"></a>决策状态</h3><p>根据表达式的返回值是true或false决定后续往哪个状态走。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">decision-state</span> <span class="attr">id</span>=<span class="string">&quot;checkDeliveryArea&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;pizzaFlowActions.checkDeliveryArea(customer.zipCode)&quot;</span> </span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">		<span class="attr">then</span>=<span class="string">&quot;addCustomer&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">		<span class="attr">else</span>=<span class="string">&quot;deliveryWarning&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">decision-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>比如上面这个例子中，根据pizzaFlowActions的checkDeliveryArea方法的返回值决定下一个状态走addCustomer还是走deliverWarning</p>
<h3 id="子流程状态"><a href="#子流程状态" class="headerlink" title="子流程状态"></a>子流程状态</h3><p>即一个节点对应一个独立的流程，这个独立流程走完后才返回原流程执行，可以类比成在一个方法中调用另一个方法。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">&quot;order&quot;</span> <span class="attr">subflow</span>=<span class="string">&quot;pizza/order&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;order&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;orderCreated&quot;</span> <span class="attr">to</span>=<span class="string">&quot;payment&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">subflow-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面这个例子中，状态名为order，它所对应的子流程为pizza/order，input标签指明了子流程的输入，即order对象，transition标签指出了当子流程的end-state即orderCreated执行完后，原流程order将转移到payment状态。</p>
<h3 id="结束状态"><a href="#结束状态" class="headerlink" title="结束状态"></a>结束状态</h3><p>结束状态执行完后，接下来发生什么？不一定</p>
<ul>
<li>如果这个end-state属于一个子流程，则这个end-state的id将作为一个事件，决定原流程接下来走哪个状态，可以参照子流程状态的例子。</li>
<li>如果end-state设置了view属性，则将展示指定的视图（相对于流程路径的视图模板），如果view属性加上externalRedirect的话，可以重定向到流程外部的页面；如果view属性加上flowRedirect前缀，将重定向到另一个流程中。</li>
<li>如果既没有设置view也不是属于子流程，则流程结束，等待用户输入并执行下一个流程。</li>
</ul>
<h2 id="转移"><a href="#转移" class="headerlink" title="转移"></a>转移</h2><p>转移是流程中各状态的连接线，可以用于action-state、view-state、subflow-state（end-state是最终节点，而decisition-state不需要指定transition）。</p>
<p>一个最简单的转移可以这样定义。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">&quot;customerReady&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>即直接指明了后面转移到customerReady状态，只有在当前状态单一出口时才可以这样定义。</p>
<p>如果当前状态有多个出口，那么就需要根据on属性来决定走哪个转移，on属性绑定了一个事件。</p>
<p>比如<transition on="phoneEntered" to="lookupCustomer"/></p>
<p>视图状态是根据用户在视图的输入产生相应的on事件，在行为状态中，事件是evaluate表达式执行的结果，在子流程状态中，事件是子流程的结束状态的id。</p>
<p>或者也可以根据抛出的异常决定转移到哪个状态。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transition</span> <span class="attr">on-exception</span>=<span class="string">&quot;com.springinaction.pizza.service.CustomerNotFoundException&quot;</span> <span class="attr">to</span>=<span class="string">&quot;regisrationForm&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="全局转移"><a href="#全局转移" class="headerlink" title="全局转移"></a>全局转移</h3><p>如果某些转移需要被引用多次，可以将其定义为全局转移。</p>
<p>transition可以定义为global-transition的子元素。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">global-transition</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">on-exception</span>=<span class="string">&quot;a&quot;</span> <span class="attr">to</span>=<span class="string">&quot;b&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">global-transition</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>比如上面这个例子，所有的状态都将拥有这个转移，当前状态抛出a异常，则转移到b状态。</p>
<h2 id="流程数据"><a href="#流程数据" class="headerlink" title="流程数据"></a>流程数据</h2><p>流程数据是保存在变量中的，可以设置这些数据的作用于，是只能在视图里访问？还是只能在当前流程访问？还是能被多个流程访问？</p>
<p>最简单的变量可以这样定义，这种变量将在整个流程内有效。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">var</span> <span class="attr">name</span>=<span class="string">&quot;cutomer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.springinaction.pizza.domain.Customer&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以用evaluate或者set元素来声明变量，比如下面这样。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;T(com.springinaction.pizza.domain.Topping.asList())&quot;</span> <span class="attr">result</span>=<span class="string">&quot;viewScope.toppingsList&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面的例子中，执行了expression，并将表达式结果放到viewScope中的toppingsList变量内。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">&quot;flowScope.pizza&quot;</span> <span class="attr">value</span>=<span class="string">&quot;new com.springinaction.pizza.domain.Pizza()&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面的例子中，将new出来的Pizza对象放到flowScope的pizza变量内。</p>
<h3 id="数据作用域"><a href="#数据作用域" class="headerlink" title="数据作用域"></a>数据作用域</h3><p>有5种作用域。</p>
<table>
<thead>
<tr>
<th>范围</th>
<th>可见性</th>
</tr>
</thead>
<tbody><tr>
<td>Conversation</td>
<td>在整个流程包括其子流程内可用</td>
</tr>
<tr>
<td>Flow</td>
<td>在当前流程内可用，可能局限于一个子流程内</td>
</tr>
<tr>
<td>Request</td>
<td>一个请求内可用，如果一个请求内走了多个流程（比如重定向了多次），则这些流程都可用</td>
</tr>
<tr>
<td>Flash</td>
<td>从当前流程开始时可用，如果在这个流程中渲染了视图，则数据会被清除，如果没渲染视图，则一直可用</td>
</tr>
<tr>
<td>View</td>
<td>只在视图状态下可用</td>
</tr>
</tbody></table>
<h1 id="完整案例：披萨订购"><a href="#完整案例：披萨订购" class="headerlink" title="完整案例：披萨订购"></a>完整案例：披萨订购</h1><p>这个案例将完整讲述从流程抽象、配置，到实现的过程，是我从Spring实战第四版书上找到的，原书的代码只有一部分，我根据原有代码结合整个流程，实现了一遍。</p>
<h2 id="Maven依赖"><a href="#Maven依赖" class="headerlink" title="Maven依赖"></a>Maven依赖</h2><p>注意除了SpringMVC依赖外，还需要引入SpringWebFlow的依赖，此外为了方便我们写View层的代码，也要引入JSTL。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.webflow<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webflow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>除了对SpringMVC进行配置以外，还需要对SpringWebFlow进行配置，下面将分别对各个配置文件进行展示。</p>
<h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><p>这边只需要配置一个DispatcherServlet即可，可以顺手把Spring配置文件也指定了，比如这个例子中是/WEB-INF/applicationContext.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>/WEB-INF/jsp/index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="SpringMVC配置"><a href="#SpringMVC配置" class="headerlink" title="SpringMVC配置"></a>SpringMVC配置</h3><p>SpringMVC只需要简单给其配置一个视图解析器即可，我这里单独建了一个文件web-mvc.xml，将其放在classpath下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;viewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;viewClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.springframework.web.servlet.view.JstlView&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="SpringWebFlow配置"><a href="#SpringWebFlow配置" class="headerlink" title="SpringWebFlow配置"></a>SpringWebFlow配置</h3><p>这个例子中，我将SpringWebFlow的配置全都写在classpath下的web-flow.xml中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:flow</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow-config&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/webflow-config</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/webflow-config/spring-webflow-config.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //流程执行器，用来管理flowRegistry</span><br><span class="line">    <span class="tag">&lt;<span class="name">flow:flow-executor</span> <span class="attr">id</span>=<span class="string">&quot;flowExecutor&quot;</span> <span class="attr">flow-registry</span>=<span class="string">&quot;flowRegistry&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    //注册流程，这里我将所有的flow都放在了/WEB-INF/flows/pizza目录下，并且每个流程定义都以-flow.xml结尾</span><br><span class="line">    <span class="tag">&lt;<span class="name">flow:flow-registry</span> <span class="attr">id</span>=<span class="string">&quot;flowRegistry&quot;</span> <span class="attr">flow-builder-services</span>=<span class="string">&quot;flowBuilderServices&quot;</span> <span class="attr">base-path</span>=<span class="string">&quot;/WEB-INF/flows/pizza&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">flow:flow-location-pattern</span> <span class="attr">value</span>=<span class="string">&quot;*-flow.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">flow:flow-registry</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //为了让SpringWebFlow的视图解析通过我们已经配置好的视图解析器，配置一个flow-builder-services，将view-factory-creator指定为一个自定义的mvcViewFactoryCreator</span><br><span class="line">    <span class="tag">&lt;<span class="name">flow:flow-builder-services</span> <span class="attr">id</span>=<span class="string">&quot;flowBuilderServices&quot;</span> <span class="attr">view-factory-creator</span>=<span class="string">&quot;mvcViewFactoryCreator&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;mvcViewFactoryCreator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.webflow.mvc.builder.MvcViewFactoryCreator&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;viewResolvers&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;viewResolver&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //将flowExecutor指定给FlowHandlerAdapater，可以类比成SpringMVC的HandlerAdapter，即可以像访问普通Controller接口那样访问流程</span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;flowHandlerAdapter&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.webflow.mvc.servlet.FlowHandlerAdapter&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;flowExecutor&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;flowExecutor&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //流程与Controller接口的映射，</span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.webflow.mvc.servlet.FlowHandlerMapping&quot;</span> <span class="attr">id</span>=<span class="string">&quot;flowHandlerMapping&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;flowRegistry&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;flowRegistry&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Spring主配置文件"><a href="#Spring主配置文件" class="headerlink" title="Spring主配置文件"></a>Spring主配置文件</h3><p>这边是最简单的，直接导入我们已经写好的web-mvc.xml和web-flow.xml即可，由于这个案例没有使用SpringBoot，所以顺手写一个自动组件扫描的配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:web-mvc.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:web-flow.xml&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.zh.pizza&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="流程实现"><a href="#流程实现" class="headerlink" title="流程实现"></a>流程实现</h2><p>整个项目实际上是一个主流程，其内部包含了若干个子流程，下面就先介绍主流程spizza-flow。</p>
<h3 id="spizza-flow主流程"><a href="#spizza-flow主流程" class="headerlink" title="spizza-flow主流程"></a>spizza-flow主流程</h3><p>主流程的图示如下，简单介绍一下，首先进入identifyCustomer子流程，即识别用户，识别完成后，触发customerReady转移，如前文所介绍的，你可以把转移视为一种事件，即identifyCustomer这个流程触发了customerReady这个事件；后续的builderOrder、takePayment都是子流程，而saveOrder是一个动作状态，thankCustomer是一个视图状态，整个流程走完后，回到start处重新开始。</p>
<p><img src="1.png" alt="1"></p>
<p>看看spizza-flow的xml定义，如下图所示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">start-state</span>=<span class="string">&quot;identifyCustomer&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //Order作为整个流程贯穿始终的参数，使用var标签定义</span><br><span class="line">    <span class="tag">&lt;<span class="name">var</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.zh.pizza.domain.Order&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    //identifyCustomer子流程，使用subflow属性来指向另一个流程</span><br><span class="line">    <span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">&quot;identifyCustomer&quot;</span> <span class="attr">subflow</span>=<span class="string">&quot;customer-flow&quot;</span>&gt;</span></span><br><span class="line">        //output可以理解为identifyCustomer这个流程的返回值,value属性为Spel表达式</span><br><span class="line">        <span class="tag">&lt;<span class="name">output</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">value</span>=<span class="string">&quot;order.customer&quot;</span>/&gt;</span></span><br><span class="line">        //触发customerReady转移，跳转至下一个子流程buildeOrder</span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;customerReady&quot;</span> <span class="attr">to</span>=<span class="string">&quot;buildOrder&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">subflow-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">&quot;buildOrder&quot;</span> <span class="attr">subflow</span>=<span class="string">&quot;order-flow&quot;</span>&gt;</span></span><br><span class="line">        //由于builderOrder内部需要用到order对象，所以使用input标签作为该子流程的入参</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;order&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;orderCreated&quot;</span> <span class="attr">to</span>=<span class="string">&quot;takePayment&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">subflow-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">&quot;takePayment&quot;</span> <span class="attr">subflow</span>=<span class="string">&quot;payment-flow&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;order&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;paymentTaken&quot;</span> <span class="attr">to</span>=<span class="string">&quot;saveOrder&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">subflow-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">&quot;saveOrder&quot;</span>&gt;</span></span><br><span class="line">        //evaluate可以用来处理一个Spel表达式</span><br><span class="line">        <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;pizzaFlowActions.saveOrder(order)&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">&quot;thankCustomer&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">&quot;thankCustomer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">&quot;endState&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //整个流程结束</span><br><span class="line">    <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">&quot;endState&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">global-transitions</span>&gt;</span></span><br><span class="line">        //如果在任意的流程中触发了cancel转移，则直接跳转至endState</span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;cancel&quot;</span> <span class="attr">to</span>=<span class="string">&quot;endState&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">global-transitions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里不关注Spel表达式背后的具体方法实现，如果你想要自己实现，可以直接到我的Github下载源码，地址贴在本文最后。</p>
<p>接下来会分别介绍各个子流程。</p>
<h3 id="identifyCustomer子流程"><a href="#identifyCustomer子流程" class="headerlink" title="identifyCustomer子流程"></a>identifyCustomer子流程</h3><p>identifyCustomer是这个子流程的id，而真正的流程定义是写在customer-flow.xml内的，这点需要注意一下。</p>
<p>可以注意到，identifyCustomer子流程并没有任何输入变量，也就是说这个流程的角色是一个单纯的生产者。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //定义子流程的全局变量customer</span><br><span class="line">    <span class="tag">&lt;<span class="name">var</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.zh.pizza.domain.Customer&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    //进入welcome视图，这里需要注意以下一般视图状态对应的是同名的视图，即welcome状态对应welcome.jsp视图</span><br><span class="line">    <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">&quot;welcome&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;phoneEntered&quot;</span> <span class="attr">to</span>=<span class="string">&quot;lookupCustomer&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">&quot;lookupCustomer&quot;</span>&gt;</span></span><br><span class="line">        //检查用户输入的手机号是否存在，若不存在，触发CustomerNotFoundException，并转移至registrationForm视图；若用户输入的手机号存在，则转移至customerReady状态</span><br><span class="line">        <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;pizzaFlowActions.lookupCustomer(requestParameters.phoneNumber)&quot;</span> <span class="attr">result</span>=<span class="string">&quot;customer&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on-exception</span>=<span class="string">&quot;org.zh.pizza.exception.CustomerNotFoundException&quot;</span> <span class="attr">to</span>=<span class="string">&quot;registrationForm&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">&quot;customerReady&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //注册表单视图，将customer绑定为该视图的model</span><br><span class="line">    <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">&quot;registrationForm&quot;</span> <span class="attr">model</span>=<span class="string">&quot;customer&quot;</span>&gt;</span></span><br><span class="line">        //on-entry的作用是在进入这个视图时做一些操作，比如这个例子中，是将lookupCustomer中用户输入的手机号绑定到customer对象内</span><br><span class="line">        <span class="tag">&lt;<span class="name">on-entry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;customer.phoneNumber = requestParameters.phoneNumber&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">on-entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">&quot;checkDeliveryArea&quot;</span> <span class="attr">on</span>=<span class="string">&quot;submit&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //决策状态，通过checkDeliveryArea方法的执行结果，决定是进入addCustomer或者是deliveryWarning两个分支</span><br><span class="line">    <span class="tag">&lt;<span class="name">decision-state</span> <span class="attr">id</span>=<span class="string">&quot;checkDeliveryArea&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;pizzaFlowActions.checkDeliveryArea(customer.zipCode)&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">then</span>=<span class="string">&quot;addCustomer&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">else</span>=<span class="string">&quot;deliveryWarning&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">decision-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">&quot;deliveryWarning&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;accept&quot;</span> <span class="attr">to</span>=<span class="string">&quot;addCustomer&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">&quot;addCustomer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;pizzaFlowActions.addCustomer(customer)&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">&quot;customerReady&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //这里的end-state的id为cancel，这与外层主流程的global-transition的cancel转移是一样的，即这里触发cancel结束状态，回到原流程时，触发cancel转移</span><br><span class="line">    <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">&quot;cancel&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    //如果时进入的时customerReady的end-state，则返回原流程的同时，将customer作为返回值返回</span><br><span class="line">    <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">&quot;customerReady&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">output</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">end-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">global-transitions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;cancel&quot;</span> <span class="attr">to</span>=<span class="string">&quot;cancel&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">global-transitions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>来看看welcome视图的定义，实际上，在SpringWebFlow中，视图层要关心的东西并不多，只是作为一个人机交互的层次。但有一点时需要注意的，即即如何确定视图触发哪个转移（触发事件），以及怎么从视图回到原先的流程中，注意这里需要导入Spring标签库。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=&quot;form&quot; uri=&quot;http://www.springframework.org/tags/form&quot; %&gt;</span><br><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: Administrator</span><br><span class="line">  Date: 2021/4/5</span><br><span class="line">  Time: 13:49</span><br><span class="line">  To change this template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; isELIgnored=&quot;false&quot;%&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spizza<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Welcome to Spizza!!!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form:form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_flowExecutionKey&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;flowExecutionKey&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;phoneNumber&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_eventId_phoneEntered&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Lookup Customer&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form:form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在来回答前面的两个问题，如何触发某个转移？将input的name设置为**_event_id_XXX**即可，其中XXX就是要触发的转移。如何从视图回到原先的流程里？在表单里设置一个隐藏域，name为_flowExecutionKey，值是从流程进入视图时自动带过来的，使用EL表达式获取它并设置到value里即可。注意这里一定得使用Spring标签库的form，否则flowExecutionKey和eventId都是不起作用的。</p>
<p>再看看deliveryWarning视图，它没有表单，但是它使用的是a标签去控制跳转。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: Administrator</span><br><span class="line">  Date: 2021/4/5</span><br><span class="line">  Time: 14:15</span><br><span class="line">  To change this template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; isELIgnored=&quot;false&quot;%&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spizza<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Delivery Unavailable<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>The address is outside of our delivery area. You may still place the order, but you will need to pick it up yourself.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;flowExecutionUrl&#125;&amp;_eventId=accept&quot;</span>&gt;</span>Continue, I&#x27;ll pick up the order<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;flowExecutionUrl&#125;&amp;_eventId=cancel&quot;</span>&gt;</span>Never mind<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意，这里a标签使用了flowExecutionUrl，它代表的原流程的地址，回到原流程的同时，我们一般还会触发一个事件，所以也带上_eventId。</p>
<h3 id="buildOrder子流程"><a href="#buildOrder子流程" class="headerlink" title="buildOrder子流程"></a>buildOrder子流程</h3><p>buildOrder流程是与用户交互，生成订单的，用户可以订购一个或多个披萨。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //将外部传进来的order对象作为本流程的全局参数</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">&quot;showOrder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;createPizza&quot;</span> <span class="attr">to</span>=<span class="string">&quot;createPizza&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;checkout&quot;</span> <span class="attr">to</span>=<span class="string">&quot;orderCreated&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;cancel&quot;</span> <span class="attr">to</span>=<span class="string">&quot;cancel&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    //将flow作用域的pizza作为model，进入createPizza视图</span><br><span class="line">    <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">&quot;createPizza&quot;</span> <span class="attr">model</span>=<span class="string">&quot;flowScope.pizza&quot;</span>&gt;</span></span><br><span class="line">        //进入createPizza视图时，自动new一个Pizza并放入flow作用域</span><br><span class="line">        <span class="tag">&lt;<span class="name">on-entry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">&quot;flowScope.pizza&quot;</span> <span class="attr">value</span>=<span class="string">&quot;new org.zh.pizza.domain.Pizza()&quot;</span>/&gt;</span></span><br><span class="line">            //注意这里还执行了一下Topping类的静态方法asList，实际上Topping是个枚举类，即配料，将配料的枚举作为List放入view作用域</span><br><span class="line">            <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;T(org.zh.pizza.domain.Topping).asList()&quot;</span> <span class="attr">result</span>=<span class="string">&quot;viewScope.toppingsList&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">on-entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;addPizza&quot;</span> <span class="attr">to</span>=<span class="string">&quot;showOrder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;order.addPizza(flowScope.pizza)&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;cancel&quot;</span> <span class="attr">to</span>=<span class="string">&quot;showOrder&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">&quot;cancel&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">&quot;orderCreated&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>先看看showOrder视图，这是buildOrder子流程的一个主要视图，主要是显示用户已经点过的披萨和配料，除了查看订单，还可以继续创建披萨或者直接进入支付流程。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=&quot;form&quot; uri=&quot;http://www.springframework.org/tags/form&quot; %&gt;</span><br><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: Administrator</span><br><span class="line">  Date: 2021/4/5</span><br><span class="line">  Time: 15:01</span><br><span class="line">  To change this template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; isELIgnored=&quot;false&quot; %&gt;</span><br><span class="line">&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spizza<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Pizza Status<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c:forEach</span> <span class="attr">var</span>=<span class="string">&quot;pizza&quot;</span> <span class="attr">items</span>=<span class="string">&quot;$&#123;order.pizzas&#125;&quot;</span>&gt;</span></span><br><span class="line">$&#123;pizza.size&#125;:</span><br><span class="line">    <span class="tag">&lt;<span class="name">c:forEach</span> <span class="attr">items</span>=<span class="string">&quot;$&#123;pizza.toppings&#125;&quot;</span> <span class="attr">var</span>=<span class="string">&quot;topping&quot;</span>&gt;</span>&amp;&amp;$&#123;topping&#125;<span class="tag">&lt;/<span class="name">c:forEach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c:forEach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;flowExecutionUrl&#125;&amp;_eventId=createPizza&quot;</span>&gt;</span>Create Pizza<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;flowExecutionUrl&#125;&amp;_eventId=checkout&quot;</span>&gt;</span>Checkout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;flowExecutionUrl&#125;&amp;_eventId=cancel&quot;</span>&gt;</span>Cancel<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加披萨的视图createPizza如下所示，注意form:form标签可以使用modelAttribute来绑定model对象，这边绑定的是流程传过来的Pizza对象。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=&quot;form&quot; uri=&quot;http://www.springframework.org/tags/form&quot; %&gt;</span><br><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: Administrator</span><br><span class="line">  Date: 2021/4/5</span><br><span class="line">  Time: 14:20</span><br><span class="line">  To change this template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; isELIgnored=&quot;false&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spizza<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Create Pizza<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form:form</span> <span class="attr">modelAttribute</span>=<span class="string">&quot;pizza&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_flowExecutionKey&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;flowExecutionKey&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b</span>&gt;</span>Size: <span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form:radiobutton</span> <span class="attr">path</span>=<span class="string">&quot;size&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Small (12-inch)&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SMALL&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form:radiobutton</span> <span class="attr">path</span>=<span class="string">&quot;size&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Medium (14-inch)&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MEDIUM&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form:radiobutton</span> <span class="attr">path</span>=<span class="string">&quot;size&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Large (16-inch)&quot;</span> <span class="attr">value</span>=<span class="string">&quot;LARGE&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form:radiobutton</span> <span class="attr">path</span>=<span class="string">&quot;size&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Ginormous (20-inch)&quot;</span> <span class="attr">value</span>=<span class="string">&quot;GINORMOUS&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b</span>&gt;</span>Toppings: <span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form:checkboxes</span> <span class="attr">path</span>=<span class="string">&quot;toppings&quot;</span> <span class="attr">items</span>=<span class="string">&quot;$&#123;toppingsList&#125;&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_eventId_addPizza&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Continue&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_eventId_cancel&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Cancel&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form:form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="takePayment子流程"><a href="#takePayment子流程" class="headerlink" title="takePayment子流程"></a>takePayment子流程</h3><p>takePayment子流程实际上相比buildOrder而言，并没有什么太多的特别之处，这边的视图略过不提，如果你想看完整的代码，可以从Github上下载源码。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/webflow</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">required</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">&quot;takePayment&quot;</span> <span class="attr">model</span>=<span class="string">&quot;flowScope.paymentDetails&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">on-entry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">&quot;flowScope.paymentDetails&quot;</span> <span class="attr">value</span>=<span class="string">&quot;pizzaFlowActions.generatePayment(order)&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;T(org.zh.pizza.domain.PaymentType).asList()&quot;</span> <span class="attr">result</span>=<span class="string">&quot;viewScope.paymentTypeList&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">on-entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;paymentSubmitted&quot;</span> <span class="attr">to</span>=<span class="string">&quot;verifyPayment&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">&quot;cancel&quot;</span> <span class="attr">to</span>=<span class="string">&quot;cancel&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">&quot;verifyPayment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">&quot;pizzaFlowActions.verifyPayment(flowScope.paymentDetails)&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">result</span>=<span class="string">&quot;order.payment&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">&quot;paymentTaken&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">&quot;cancel&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">&quot;paymentTaken&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h2><p>进入流程后，第一个看到的页面为welcome.jsp。</p>
<p><img src="2.png" alt="2"></p>
<p>如果没有注册过，进入registrationForm.jsp，注意这里输入的zipCode是会接收检查的。</p>
<p><img src="3.png" alt="3"></p>
<p>若zipCode检查不通过，会进入deliveryWarning.jsp。</p>
<p><img src="4.png" alt="4"></p>
<p>点击第一个超链接，进入showOrder.jsp，一开始没有任何订单，你可以点击Create Pizza来创建披萨，也可以点击Checkout前往支付。</p>
<p><img src="5.png" alt="5"></p>
<p>如果点击Create Pizza，则需要选择披萨尺寸和配料。</p>
<p><img src="6.png" alt="6"></p>
<p>重新回到订单页面，可以看到最新的订单信息已经同步过来了。</p>
<p><img src="7.png" alt="7"></p>
<p>点击支付Checkout，系统会自动计算费用，我们自己要做的仅仅只是勾选支付方式。</p>
<p><img src="8.png" alt="8"></p>
<p>完成整个流程，进入thankCustomer.jsp，点击finish，即可回到首页。</p>
<p><img src="9.png" alt="9"></p>
<p>在这个过程中，点击任意的Cancel按钮，都会触发cancel转移，从而结束整个流程，返回首页。</p>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>可以从这个Github仓库找到上述案例的完整代码。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ZenoXen/pizza-flow-demo">SpringWebFlow案例</a></p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://www.manning.com/books/spring-in-action-fourth-edition">Spring实战第四版</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012562943/article/details/50264845">SpringWebFlow实例教程</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Spring/" rel="tag"><i class="fa fa-tag"></i> Spring</a>
              <a href="/tags/SpringWebFlow/" rel="tag"><i class="fa fa-tag"></i> SpringWebFlow</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/03/01/Spring%E4%B8%8ERedis%E6%95%B4%E5%90%88/" rel="prev" title="Spring与Redis整合">
                  <i class="fa fa-chevron-left"></i> Spring与Redis整合
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/03/04/SpringValidation%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97--Controller%E4%B8%8EService%E5%85%A5%E5%8F%82%E6%A0%A1%E9%AA%8C/" rel="next" title="SpringValidation使用指南--Controller与Service入参校验">
                  SpringValidation使用指南--Controller与Service入参校验 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备2021020918号 </a>
      <img src="/uploads/beian.png" alt=""><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=2021020918" rel="noopener" target="_blank">浙ICP备2021020918号-1 </a>
  </div>

<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZenoX</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"18kXE9grlsG6iGdodFBPKRhS-gzGzoHsz","app_key":"Cr75M3StnSKrVX6uAoGUkYKr","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"ZenoXen/ZenoXen.github.io","issue_term":"title","theme":"github-light","cdn":"https://utteranc.es/client.js"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
